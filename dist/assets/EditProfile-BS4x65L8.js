import{r as x,j as e,u as D,b as F}from"./index-C4Srh_oV.js";import{l as L,s as T}from"./profileUtils-CQMFgpeE.js";function B({initial:o,onChange:m}){const d=x.useRef(null),[t,r]=x.useState(o);x.useEffect(()=>{r(o)},[o]);function g(){var n;(n=d.current)==null||n.click()}function b(){r(null),m(null),d.current&&(d.current.value="")}function v(n){var f;const i=(f=n.target.files)==null?void 0:f[0];if(!i)return;const p=new FileReader;p.onload=()=>{const h=typeof p.result=="string"?p.result:null;r(h),m(h)},p.readAsDataURL(i)}return e.jsx("div",{className:"p-4 border rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-24 h-24 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center",children:t?e.jsx("img",{src:t,alt:"profile",className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-xs text-slate-500",children:"No image"})}),e.jsxs("div",{className:"space-x-2",children:[e.jsx("button",{type:"button",onClick:g,className:"px-3 py-2 rounded-xl border",children:"Choose image"}),t&&e.jsx("button",{type:"button",onClick:b,className:"px-3 py-2 rounded-xl border",children:"Remove"}),e.jsx("input",{ref:d,type:"file",accept:"image/*",className:"hidden",onChange:v}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:"Images are stored locally in your browser."})]})]})})}function J(){var f,h,y,w,C,k,P,S,E,_,I,R;const{user:o}=D(),m=o==null?void 0:o.email,d=F(),[t,r]=x.useState({name:"",username:"",bio:"",image:"",email:m||"",phone:"",parentalContact:[{name:"",email:"",phone:""},{name:"",email:"",phone:""}],instagram:"",facebook:""}),[g,b]=x.useState(!1),v=!!localStorage.getItem("mindmate_user_token");x.useEffect(()=>{let a=!0;async function u(){try{const l=localStorage.getItem("mindmate_user_token");if(l){const c=await fetch("/api/auth/profile",{headers:{Authorization:`Bearer ${l}`}});if(c.ok){const j=await c.json(),N=j==null?void 0:j.profile;if(a&&N){const U=N.parentalContact||[{name:"",email:"",phone:""},{name:"",email:"",phone:""}];r(A=>({...A,...N,parentalContact:U}));return}}}}catch{}const s=L(m);if(a&&s){const l=s.parentalContact||[{name:"",email:"",phone:""},{name:"",email:"",phone:""}];r(c=>({...c,...s,parentalContact:l}))}else a&&o&&r(l=>({...l,name:o.name||l.name,username:o.username||l.username,email:o.email||l.email}))}return u(),()=>{a=!1}},[m,o]);function n(a,u){r(s=>({...s,[a]:u}))}function i(a,u,s){const l=(t.parentalContact||[]).slice(0,2);l[a]={...l[a]||{name:"",email:"",phone:""},[u]:s},r(c=>({...c,parentalContact:l}))}async function p(){var a,u,s;b(!0);try{const l=localStorage.getItem("mindmate_user_token");if(l){if(!(await fetch("/api/auth/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({name:t.name,username:t.username,bio:t.bio,image:t.image,phone:t.phone,instagram:t.instagram,facebook:t.facebook,parentalContact:(t.parentalContact||[]).slice(0,2)})})).ok)throw new Error("Server save failed")}else if(!T(m,t))throw new Error("Local save failed");(a=window.motivateToast)==null||a.call(window,"Profile saved"),d("/profile")}catch{T(m,t)?((u=window.motivateToast)==null||u.call(window,"Saved locally (offline)"),d("/profile")):(s=window.motivateToast)==null||s.call(window,"Failed to save profile")}finally{b(!1)}}return e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Edit profile"}),e.jsxs("p",{className:"text-sm text-slate-500 mt-1",children:["Update your details. ",v?"Data is stored on the server and syncs across devices.":"Data is stored in your browser."]})]})}),e.jsxs("div",{className:"mt-4 grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Display name"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",value:t.name||"",onChange:a=>n("name",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-3",children:"Username"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",value:t.username||"",onChange:a=>n("username",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-3",children:"Bio"}),e.jsx("textarea",{rows:4,className:"w-full mt-1 rounded-xl border px-3 py-2",value:t.bio||"",onChange:a=>n("bio",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-3",children:"Email"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",value:t.email||"",onChange:a=>n("email",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-3",children:"Phone"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",value:t.phone||"",onChange:a=>n("phone",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Profile image"}),e.jsx(B,{initial:t.image??null,onChange:a=>n("image",a||void 0)}),e.jsx("label",{className:"block text-sm font-medium mt-4",children:"Parental / Loved-one contact 1"}),e.jsx("input",{placeholder:"Name",className:"w-full mt-1 rounded-xl border px-3 py-2",value:((h=(f=t.parentalContact)==null?void 0:f[0])==null?void 0:h.name)||"",onChange:a=>i(0,"name",a.target.value)}),e.jsx("input",{placeholder:"Email",className:"w-full mt-2 rounded-xl border px-3 py-2",value:((w=(y=t.parentalContact)==null?void 0:y[0])==null?void 0:w.email)||"",onChange:a=>i(0,"email",a.target.value)}),e.jsx("input",{placeholder:"Phone",className:"w-full mt-2 rounded-xl border px-3 py-2",value:((k=(C=t.parentalContact)==null?void 0:C[0])==null?void 0:k.phone)||"",onChange:a=>i(0,"phone",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-4",children:"Parental / Loved-one contact 2 (optional)"}),e.jsx("input",{placeholder:"Name",className:"w-full mt-1 rounded-xl border px-3 py-2",value:((S=(P=t.parentalContact)==null?void 0:P[1])==null?void 0:S.name)||"",onChange:a=>i(1,"name",a.target.value)}),e.jsx("input",{placeholder:"Email",className:"w-full mt-2 rounded-xl border px-3 py-2",value:((_=(E=t.parentalContact)==null?void 0:E[1])==null?void 0:_.email)||"",onChange:a=>i(1,"email",a.target.value)}),e.jsx("input",{placeholder:"Phone",className:"w-full mt-2 rounded-xl border px-3 py-2",value:((R=(I=t.parentalContact)==null?void 0:I[1])==null?void 0:R.phone)||"",onChange:a=>i(1,"phone",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-4",children:"Instagram (id only)"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",placeholder:"e.g., your_handle",value:t.instagram||"",onChange:a=>n("instagram",a.target.value)}),e.jsx("label",{className:"block text-sm font-medium mt-3",children:"Facebook (id only)"}),e.jsx("input",{className:"w-full mt-1 rounded-xl border px-3 py-2",placeholder:"e.g., your.profile",value:t.facebook||"",onChange:a=>n("facebook",a.target.value)})]})]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-forest-600 text-white",onClick:p,disabled:g,children:g?"Savingâ€¦":"Save"}),e.jsx("button",{className:"px-4 py-2 rounded-xl border",onClick:()=>d("/profile"),children:"Cancel"})]})]})})}export{J as default};
